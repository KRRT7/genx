<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using GenX from the command line (with mpi) &#8212; GenX 2.4.9 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.6/flatly/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.4.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/genx.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Frequently Asked Questions" href="../faq.html" />
    <link rel="prev" title="Beta Roughness Model" href="beta_rough.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          GenX</a>
        <span class="navbar-text navbar-version pull-left"><b>2.4</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Content <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../install.html#windows">Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install.html#mac-os-x">Mac OS-X</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install.html#from-source">From source</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html#reflectivity">Reflectivity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html#surface-x-ray-diffraction">Surface x-ray diffraction</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../tutorials.html#other-tutorials">Other tutorials</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#general">General</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#fitting">Fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#reflectivity">Reflectivity</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">Development documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../development/data.html">Data classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/write_data_loader.html">How to write a Data Loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/write_fom.html">Writing a FOM function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/packaging.html">How to package GenX</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development/mag_refl.html">A model for magnetic reflectivity</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Using GenX from the command line (with mpi)</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li><a class="reference internal" href="#command-line-arguments">Command line arguments</a></li>
<li><a class="reference internal" href="#using-mpi">Using MPI</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="using-genx-from-the-command-line-with-mpi">
<span id="tutorial-mpi"></span><h1>Using GenX from the command line (with mpi)<a class="headerlink" href="#using-genx-from-the-command-line-with-mpi" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Using GenX from the command line lets you in the simplest case start up the gui. As of version 2.3 you can also
run fits without starting up the gui at all. This opens possibilities to make batch script of multiple GenX runs and
in addition you can run GenX on machines without a desktop environment. As GenX also since 2.3 supports mpi for fitting
in parallel opens up the possibility to use it on clusters. The mpi implementation was contributed by Canrong Qiu.
Note that currently the command line is only fully implemented in the source version.</p>
</div>
<div class="section" id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<p>If you only intend to run GenX from the command line you do not need an installation of wxPython, appdirs or matplotlib.
Thus the packages you need are:</p>
<ul class="simple">
<li>Python newer than 2.3.5</li>
<li>Numpy version &gt; 1.0</li>
<li>Scipy version &gt; 0.5</li>
<li>h5py version &gt; ?</li>
<li>If using mpi you will need mpi4py as well as an mpi installation.</li>
</ul>
</div>
<div class="section" id="command-line-arguments">
<h2>Command line arguments<a class="headerlink" href="#command-line-arguments" title="Permalink to this headline">¶</a></h2>
<p>The arguments to GenX can be viewed by executing the program with the <code class="docutils literal"><span class="pre">--help</span></code> option.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ python genx.py --help
usage: genx.py [-h] [-r | --mpi] [--pr PR] [--cs CS] [--mgen MGEN]
               [--pops POPS] [--asi ASI] [--km KM] [--kr KR] [-s] [-e]
               [infile] [outfile]

GenX 2.3.5, fits data to a model.

positional arguments:
  infile       The .gx or .hgx file to load
  outfile      The .gx or hgx file to save into

optional arguments:
  -h, --help   show this help message and exit
  -r, --run    run GenX fit (no gui)
  --mpi        run GenX fit with mpi (no gui)

optimization arguments:
  --pr PR      Number of processes used in parallel fitting.
  --cs CS      Chunk size used for parallel processing.
  --mgen MGEN  Maximum number of generations that is used in a fit
  --pops POPS  Population size - number of individuals.
  --asi ASI    Auto save interval (generations).
  --km KM      Mutation constant (float 0 &lt; km &lt; 1)
  --kr KR      Cross over constant (float 0 &lt; kr &lt; 1)
  -s, --esave  Force save evals to gx file.
  -e, --error  Calculate error bars before saving to file.

For support, manuals and bug reporting see http://genx.sf.net
</pre></div>
</div>
<p>To run a fit using the multiprocessing module (forking different processes) which is the same code as in the gui
the following command can be executed.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ python genx.py --run --mgen=10 ./examples/X-ray_Reflectivity.gx test.gx
Loading model /Users/GenX/Desktop/v2.3.5/examples/X-ray_Reflectivity.gx...
Simulating model...
Setting up the optimizer...
DE initilized
Setting up a pool of workers ...
Starting a pool with 2 workers ...
Saving the initial model to /Users/GenX/Desktop/v2.3.5/test.gx
Fitting starting...
Calculating start FOM ...
Going into optimization ...
FOM: 0.277 Generation: 1 Speed: 541.6
FOM: 0.277 Generation: 2 Speed: 550.4
FOM: 0.268 Generation: 3 Speed: 528.7
FOM: 0.268 Generation: 4 Speed: 544.2
FOM: 0.243 Generation: 5 Speed: 546.8
FOM: 0.243 Generation: 6 Speed: 544.7
FOM: 0.243 Generation: 7 Speed: 549.8
FOM: 0.243 Generation: 8 Speed: 544.1
FOM: 0.218 Generation: 9 Speed: 546.9
FOM: 0.215 Generation: 10 Speed: 550.1
Stopped at Generation: 10 after 500 fom evaluations...
Fitting finished!
Time to fit:  0.0183591683706  min
Updating the parameters
Saving the fit to /Users/GenX/Desktop/v2.3.5/test.gx
Fitting successfully completed
</pre></div>
</div>
<p>As can be seen this loads the file <code class="docutils literal"><span class="pre">./examples/X-ray_Reflectivity.gx</span></code> sets the maximum number of generation to run
to 10 and then runs the fit. The result is saved to <code class="docutils literal"><span class="pre">test.gx</span></code>. Note that to be able to analyse the fits (calculate error bars
for example) the option <code class="docutils literal"><span class="pre">--esave</span></code> should be used. If the fits take a long time to run it is advisable to save them
every now and then with the <code class="docutils literal"><span class="pre">--asi</span></code> command that specifies how often the current result should be written to file.
It can also be good idea to directly calculate the errorbars before saving to file with the <code class="docutils literal"><span class="pre">-e</span></code> command.
Another point to see is that there is a significant speed-up when only using the command line. This is probably due to
that the GUI does not have to be updated.</p>
</div>
<div class="section" id="using-mpi">
<h2>Using MPI<a class="headerlink" href="#using-mpi" title="Permalink to this headline">¶</a></h2>
<p>If MPI and mpi4py is installed on the system the <code class="docutils literal"><span class="pre">--mpi</span></code> switch will be activated. Note that the description for
<code class="docutils literal"><span class="pre">--mpi</span></code> in the help will not appear until the mpi4py can loaded correctly. In order to use mpi the command <code class="docutils literal"><span class="pre">mpirun</span></code>
or <code class="docutils literal"><span class="pre">mpiexec</span></code> has to be used. The argument <code class="docutils literal"><span class="pre">-np</span></code> defines how many processes to use. An example can be seen below.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ mpirun -np 2 python genx.py --mpi --mgen=10 ./examples/X-ray_Reflectivity.gx test.gx
Loading model /Users/GenX/Desktop/v2.3.5/examples/X-ray_Reflectivity.gx...
Simulating model...
Setting up the optimizer...
DE initilized
Inits mpi with 2 processes ...
Saving the initial model to /Users/GenX/Desktop/v2.3.5/test.gx
Fitting starting...
Calculating start FOM ...
Going into optimization ...
FOM: 0.288 Generation: 1 Speed: 549.5
FOM: 0.288 Generation: 2 Speed: 550.3
FOM: 0.288 Generation: 3 Speed: 561.3
FOM: 0.240 Generation: 4 Speed: 563.7
FOM: 0.240 Generation: 5 Speed: 566.1
FOM: 0.240 Generation: 6 Speed: 560.2
FOM: 0.209 Generation: 7 Speed: 563.9
FOM: 0.209 Generation: 8 Speed: 559.6
FOM: 0.209 Generation: 9 Speed: 564.2
FOM: 0.190 Generation: 10 Speed: 559.5
Stopped at Generation: 10 after 500 fom evaluations...
Fitting finished!
Time to fit:  0.0177068511645  min
Updating the parameters
Saving the fit to /Users/GenX/Desktop/v2.3.5/test.gx
Fitting successfully completed
</pre></div>
</div>
<p>As MPI defines its process externally and the code calculates the chunk size automatically the arguments <code class="docutils literal"><span class="pre">-pr</span></code> and
<code class="docutils literal"><span class="pre">--cr</span></code> will not be used in this case. This should be the only changes compared to using it from the command line as
usual.</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../_sources/tutorials/mpi.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2017, Matts Björck.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>